![elasticsearch_doc.png](..%2Fimages%2Felasticsearch_doc.png)
这里是ElasticSearch官方文档第一章“”的学习笔记
# 什么是 Elasticsearch？
Elasticsearch 是 Elastic Stack 核心的**分布式搜索和分析**引擎，也是业界最常用的文本搜索引擎，提供各种组件和功能为构建搜索能力提供强大的服务。
- Logstash 和 Beats 有助于收集、聚合和丰富数据并存储在 Elasticsearch 中。
- Kibana 使用户能够以**交互方式**探索、**可视化**和共享对数据的见解，并管理和监控堆栈。

## Elasticsearch的功能特点
Elasticsearch 具备创建索引进行数据存储、全文搜索和数据分析的功能。
* 支持为所有类型数据提供**近实时**搜索和分析功能（包括结构化、非结构化文本、数字数据、地理空间数据等）；
* 分布式集群扩展特性，支持**无缝扩展**部署实例，不影响线上功能；

## Elasticsearch可以做什么？
ElasticSearch可以在各种场景下提供数据搜索和分析能力，拥有优秀的处理数据的速度和灵活性。
* 为应用或网站提供搜索能力：如为网站提供文本搜索能力；
* 存储和分析日志、指标和安全事件数据：如分析某个网站每天的搜索点击次数和点击率；
* 使用机器学习实时地对数据行为进行自动建模
* 使用 Elasticsearch 作为存储引擎实现业务工作流自动化
* 使用 Elasticsearch 作为地理信息系统 (GIS) 管理、集成和分析空间信息 
* 使用 Elasticsearch 作为生物信息学研究工具存储和处理遗传数据
尽管用户使用ElasticSearch的意图不同，但ElasticSearch在处理数据、文档和索引的方式上都是相同的。

## ElasticSearch 数据存储格式：文档和索引
Elasticsearch是一个分布式文档存储数据库。
它将数据库称为索引，同一个索引中的数据具有相同的数据结构。索引中的一条数据称为一个文档，
不似我们常用的表格形式数据库，将信息存储为列式数据行。ElasticSearch将信息序列化为复杂结构的json进行存储。
* 可以将索引视为文档的集合，每个文档都是字段的集合，字段是包含数据的键值对。
* 默认情况下，在Elasticsearch 索引创建阶段，会索引每个字段中的所有数据，并且每个索引字段都有一个专用的数据结构。

| 数据类型    | 数据结构 |
|:---------|:------|
| text/keyword | 倒排索引 |
| 数字/地理位置 | BKD树 |

* 使用每个字段的数据结构来组合和返回搜索结果的能力是 Elasticsearch 如此快速的原因。
### 什么是倒排索引？
[什么是倒排索引结构.md](%CA%B2%C3%B4%CA%C7%B5%B9%C5%C5%CB%F7%D2%FD%BD%E1%B9%B9.md)
### 什么是BKD树？
[什么是BKD树结构.md](%CA%B2%C3%B4%CA%C7BKD%CA%F7%BD%E1%B9%B9.md)

## 索引的创建过程会经历哪些不种族：
1) 分词建立倒排索引：<br>
存文档时，ElasticSearch会在 1 秒内近乎实时地对其进行分词、建立索引结构。
2) 分布至多节点多分片和副本上：<br>
当集群中有多个节点时，存储的文档分布在整个集群中，并且可以立即从任何节点访问。

## Elasticsearch的Schema-Less 模式
### 什么是schema?
对于Elasticsearch的一个索引库来说使用`GET /index_name`
可以查看索引中的所有字段和各个字段的类型，即schema。
### 什么是schema-less?
Elasticsearch还具有**schema-less**的能力，这意味着可以不明确定义索引的schema。
向索引中添加schema中没有定义的字段，ElasticSearch也可以对文档进行索引。
启用**动态映射**（dynamic mapping）后，Elasticsearch 会自动检测新字段的类型，如布尔值、浮点和整数值、日期和字符串等，并将其映射到适当的 Elasticsearch 数据类型添加到索引库中。
### schema-less模式的优缺点
**优势**：这种默认行为使得索引和浏览数据变得容易。<br>
**劣势**：当用户错误地导入数据时，会破坏索引的结构，不会报错或者提示。我在使用ElasticSearch的动态映射功能时，常常苦恼于错误操作而导致的重新刷库。
此外，Elasticsearch远没有用户自己了解数据和使用意图，
它只能识别出数据的简单类型，而无法自动了解用户的意图，定义更复杂的数据类型。

例如，用户通过定义规则来控制动态映射，可以显式定义自己的映射，更好地控制字段的存储和索引方式：
 
* 区分full-text 字符串字段和精确值（exact value）字符串字段 
* 执行特定语言的文本分析
* 优化字段以进行部分匹配 
* 使用自定义的日期格式
* 使用无法自动检测的数据类型，如"geo_point"和"geo_shape"

在实际的搜索索引中，还会出于不同的目的为同一字段定义不同的数据类型。
例如，可能希望将字符串字段title索引为用于全文搜索的文本text字段和用于排序或聚合数据的关键字keyword字段。
或者，希望选择使用多个语言分析器来处理包含用户输入的字符串字段的内容。

在创建索引的期间，应用于全文字段的分析链也在搜索时使用。
查询全文字段时，在索引中查找术语之前，查询文本将进行相同的分析。

# 可扩展性和弹性:集群、节点和分片
## ElasticSearch的可扩展集群
当我们初次构建一个ElasticSearch集群时,数据量较少。然而,随着用户的增加,数据也会不断增多。如果我们一直使用同一套集群资源,搜索速度将会变得越来越慢。那么,Elasticsearch是如何解决这个问题的呢?

Elasticsearch采用了集群模式,可以根据搜索需求来扩展集群资源,确保搜索功能始终可用。具体做法是通过部署新的ElasticSearch节点并将其添加到集群中:
* **自然分布**:我们可以将服务器(节点)添加到集群中以增加容量。Elasticsearch会自动在所有可用节点之间分配数据和查询负载。
* **在线更新**:无需完全断开应用程序的连接,Elasticsearch可以自动平衡多节点集群,提供可扩展性和高可用性。
* **集群规模**:集群中节点数量越多,搜索性能越好。

### 工作原理是什么?
**索引的分片存储机制:**
实际上,Elasticsearch的索引是以一个或多个物理分片的非逻辑分组进行存储的。每个分片实际上是一个包含部分数据的索引。
通过将索引中的文档分布在多个分片上,并将这些分片分布在多个节点上,Elasticsearch可以确保数据的冗余性,既可以防止硬件故障,又可以在将节点添加到集群时增加查询容量。
随着集群的增长或收缩,Elasticsearch会自动迁移分片,重新平衡集群。

分片分为两种类型:主分片和副本分片。
* **主分片**:索引中的每个文档都属于一个主分片。主分片的数量在创建索引时设定,如果需要修改数量,则需要重新创建索引。
* **副本分片**:主分片的副本(备份),提供数据的冗余副本,以防止硬件故障,并增加处理读取请求(如搜索或检索文档)的能力,提高搜索的并发请求数量。副本分片的数量可以随时更改,不会中断索引或查询操作。

## 如何确定分片的大小和数量

在**确定分片大小**和为索引配置**主分片数量**时,需要考虑许多性能注意事项和权衡。
分片越多,维护这些索引的开销就越大。
分片大小越大,当Elasticsearch需要重新平衡集群时,移动分片所需的时间就越长。

查询大量小分片可以加快每个分片的处理速度,但同时也意味着增加了开销。因此,查询较少数量的较大分片可能会更快。
总之,索引的主副分片数量的设置应根据具体的使用情况而定。

简单的规则如下:

* 分片的平均大小应保持在几GB到几十GB之间。对于基于时间的数据使用案例,通常会使用20GB到40GB范围内的分片。
* 避免创建过多的分片。每个节点可以容纳的分片数量与可用的堆空间成正比。一般来说,每GB堆空间的分片数应小于20。

确定最佳配置的最佳方法是使用数据和查询进行测试。

### 在灾难发生时保持高可用性
集群中的节点需要良好且可靠的连接。为了提供更好的连接,通常会将节点放置在同一个数据中心或附近的数据中心。然而,为了保持高可用性,您还需要避免任何单点故障。如果一个位置发生重大中断,另一个位置的服务器需要能够接管工作。
**跨集群复制 (CCR)**

CCR提供了一种将索引从主集群自动同步到辅助远程集群以用作热备份的方法。如果主集群发生故障,辅助集群可以接管工作。此外,CCR还可以创建辅助群集,以便在地理位置接近的情况下为用户提供读取请求。

跨集群复制是一种主动-被动的机制。主集群上的索引是活动领导索引,负责处理所有写入请求。而复制到辅助集群的索引是只读的追随者。

#### 维护
与任何企业系统一样,您需要工具来保护、管理和监控您的Elasticsearch集群。Elasticsearch集成了安全、监控和管理功能,使您能够使用Kibana作为管理集群的控制中心。通过数据汇总和索引生命周期管理等功能,您可以智能地管理数据随着时间的推移而变化的需求。
![wechat](../images/wechat.png)