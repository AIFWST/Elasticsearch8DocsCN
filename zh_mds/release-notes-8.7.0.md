

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[Release
notes](es-release-notes.md)

[« Elasticsearch version 8.7.1](release-notes-8.7.1.md) [Elasticsearch
version 8.6.2 »](release-notes-8.6.2.md)

## 弹性搜索版本8.7.0

另请参阅 8.7 中的重大更改。

### 已知问题

* 分片重新平衡可能会暂时使集群失去平衡

从 8.6.0 开始，默认的分片重新平衡算法将计算最终的期望余额，然后进行分片移动以协调集群的当前状态与期望状态。但是，分片移动发生的顺序可能会偏向某些节点，从而导致集群在协调过程中暂时变得不平衡。与往常一样，一旦节点达到磁盘水印，它将不接受任何其他分片，但这种倾斜可能会导致节点在正常操作中比预期更频繁地到达其磁盘水印。对帐过程完成后，群集将再次平衡。

要避免此问题，请升级到 8.8.0 或更高版本。

### 重大变更

采集节点

    

* 使"JsonProcessor"更严格，以便它不会静默丢弃数据 #93179(问题：#92898)

### 错误修正

Aggregations

    

* 不要为空存储桶创建新的"双直方图"实例 #92547 * 修复：不允许字符串 #88686 以外的映射键类型(问题：#66057)

Allocation

    

* 预测不可用时回退到实际分片大小 #93461 * 未恢复群集状态时跳过"磁盘阈值监视器" #93699 * 禁止"分配操作多侦听器"中的响应标头 #93777(问题：#93773)

Authentication

    

* 重写"身份验证"时正确从领域中删除域，以便与不支持域的节点版本兼容 #93276

Authorization

    

* 修复 Security 的表达式解析器不删除不可用但授权的名称 #92625

CCR

    

* 删除重复数据繁重的 CCR 存储库 CS 请求 #91398

CRUD

    

* 避免在无状态 Get/mGet 中使用 NPE #94164 * 不要刷新"TransportBulkAction"中的所有索引 #93417

集群协调

    

* 延迟主任务失败通知，直到提交 #92693(问题：#92677)

数据流

    

* 允许在"数据流别名"#92692 中为每个"数据流"使用不同的过滤器(问题：#92050)

Geo

    

* 在跨群集矢量图块搜索中构建索引限定名称 #94574(问题：#94557) * 使用球面坐标检查地理点上的"GeohexGrid"边界 #92460 * 修复在矢量图块中裁剪几何集合时的错误 #93562

Health

    

* 在磁盘水印计算中考虑"max_headroom" #93157(问题：#93155)

ILM+SLM

    

* 允许 ILM 步骤过渡到相终端步骤 #91754 * 避免 ILMHistoryStore #91238 中的"批量处理器"死锁(问题：#68468、#50440) * 修复了仅更改"可搜索快照操作"中的"forceMerge"标志不会更新策略的问题 #93847 * 防止 ILM 和 SLM 运行时状态存储在快照中 #92252

Infra/CLI

    

* 将打印引导程序检查恢复为错误 #93178(问题：#93074)

Infra/Core

    

* 将"jdk.internal.reflect"权限添加到 es 代码库 #92387(问题：#92356) * 仅通过抑制的异常添加异常循环检查 #93944(问题：#93943) * 确保一次性包装器释放其委托 #92928 * 修复"输入流#读取所有字节"在"输入流索引输入"#92680 * 修复带有冒号的日期数学的索引解析器 #92973 * 使"过滤器流输入"不那么陷阱 #92422

Infra/Plugins

    

* 确保插件初始化的顺序 #93882 (问题： #93851) * 修复"类阅读器"#92890 中未关闭的目录流(问题： #92866) * 更新插件扫描程序 #92784 使用的 asm 版本(问题：#92782)

基础设施/休息接口

    

* REST API 兼容性] 使用参数格式化响应媒体类型 [#92695

Infra/Scripting

    

* 修复了在数组类型上调用方法时的 NPE#91713(问题：#87562)

Infra/Settings

    

* 修复了 ILM 操作员设置 #94477 的解析失败(问题：#94465)

采集节点

    

* 更好的名称和类型用于摄取统计信息 #93533(问题：#80763) * 正确处理摄取失败的异常情况 #92455 * 禁用摄取附件日志记录 #93878 * 仅在需要时下载 geoip 数据库 #92335(问题：#90673) * 将模拟调用转发到采集节点 #92171 * Grok 返回重复模式名称的匹配项列表 #92092 #92586(问题：#92092) * 以最小的额外开销处理默认/请求管道和最终管道 #93329(问题： #92843， #81244， #93118) * 摄取附件模块 tika 依赖项版本 #93755 * 更准确的总摄取统计信息 #91730(问题：#91358) * 加速摄取 geoip 处理器 #92372 * 加速摄取集和追加处理器 #92395

机器学习

    

* 如果未设置区域感知属性，则分配训练模型 #94128(问题：#94123) * 修复启动数据馈送时的数据计数争用条件 #93324(问题：#93298) * 修复在 BERT 和 MPNet 中处理规范化时的标记化错误 #92329 * 取消模型加载时正确释放资源 #92204 * 当存在超集时，停止报告子集的"frequent_items"聚合 #92239 * 在摄取时使用长推理超时 #93731

Mapping

    

* 修复无效日期的动态映射检测 #94115(问题：#93888) * 仅源关键字字段不进行长度检查 #93299(问题：#9304)

Network

    

* 延迟连接#打开在挂起时已删除 #92546 * 修复在 TLS 握手完成之前开始的 fransport 握手 #90534(问题：#77999) * 保护"节点连接服务"免受过时连接 #92558(问题：#92029)

Recovery

    

* 在恢复开始之前禁用恢复监视器 #93551 (问题： #93542) * 修复"远程恢复处理程序"中的潜在泄漏 #91802 * 将恢复的文件报告为从快照中恢复，以获得完全装载的可搜索快照 #92976

Rollup

    

* 缩减采样未映射的文本字段 #94387(问题：#94346) * 传播时间戳格式并将纳秒转换为毫秒 #94141(问题：#94085) * 失败时停止处理"传输下采样操作" #94624 * 支持直方图作为标签的缩减采样 #93445(问题：#93263)

Search

    

* 为折叠字段上的排序字段添加空检查 #94546(问题：#94407) * 当搜索同时包含注释和注释术语时，带注释的荧光笔不匹配 #92920(问题：#91944) * 清除字段上限索引响应 取消 #93716 (问题： #93029) * 默认情况下不要在 PIT 中包含冻结的索引 #94377 * 修复奇怪情况下前缀查询抛出的 NPE #94369 * 修复_id字段获取问题。#94528(问题：#94515)* 修复存储字段提取时的元数据"_size" #94483(问题：#94468) * 修复了"配置文件权重"中匹配项缺少的覆盖 #92360 * 在"copy_to"期间不应添加嵌套路径信息 #93340(问题：#93117) * 启动时使用所有分析事件 #92087 * 对"术语向量服务"中的未标记字段使用关键字分析器 #94518 * 性能分析] 调整最后一个数据切片的处理 [#94283 * 性能分析] 确保仅发送一次响应 [#93692(问题： #93691) * 分析] 处理响应处理错误 [#93860

Snapshot/Restore

    

* 修复了 blobstore 存储库包含意外文件时未处理的异常 #93914 * 支持 GCS API 中所有位置的 GCS 代理 #92192(问题：#91952)

Stats

    

* 避免在 TBbNA #92255 中捕获群集状态

TSDB

    

* 修复稀疏"_doc_count"字段的合成"_source"#91769(问题：#91731)

任务管理

    

* 修复列表任务 API #93431 中的上下文泄漏(问题：#93428)

Transform

    

* 将"sourceHasChanged"调用集成到故障处理和重试逻辑中 #92762(问题：#92133)

矢量搜索

    

* 修复 kNN 搜索的"maxScore"计算 #93875 * 修复 kNN 搜索匹配项 #93876 的说明

###Enhancements

Aggregations

    

* 使用领先的全局有序值源优化复合 AGG #92197

Allocation

    

* 将"forecasted_write_load"和"forecasted_shard_size_in_bytes"添加到端点 #92303 * 通过内部端点公开层平衡统计信息 #92199 * 引入 ShardRouting.Role #92668 * 预验证节点删除 API(第 2 点) #91256(问题：#87776) * 使用 cluster_concurrent_rebalance=2 模拟移动 #93977 * 不可升级的跳过复制和对等恢复 #93210

Authentication

    

* 将新的"token_type"设置添加到 JWT 领域 #91536 * JWT 领域 - 对访问令牌的初始支持 #91781 * JWT 领域 - 简化令牌主体计算 #92315 * JWT 领域 - 添加对所需声明的支持 #92314 * 支持自定义 PBKDF2 密码哈希 #92871

Authorization

    

* 允许的索引匹配器支持嵌套的有限角色 #93306 * 舰队转换升级的额外"kibana_system"权限 #91499 * 预授权子搜索传输操作 #91886

集群协调

    

* 添加指向故障排除文档的链接 #92755 (问题： #92741) * 改进节点 {join，左} 日志记录以进行故障排除 #92742 * 重复"cluster.initial_master_nodes"日志警告 #92744

EQL

    

* EQL 样本：为每个键添加对多个样本的支持 #91783

Engine

    

* 为"InternalEngine"和"CombinedDeletePolicy"添加提交侦听器 #92017 * 将主要术语供应商添加到 Engine.IndexCommitListener #92101 * 调整索引中允许的删除百分比范围 #93188 * 比较每个新提交添加的文件名列表 #92238 * 将固定复合文件阈值设置为 1GB #92659

Geo

    

* 向 H3#hexRing 添加方法以防止分配长数组 #92711 * 添加方法以防止在 H3 API 上的子导航期间分配长数组 #92099 * 添加新的 H3 API 方法 #h3ToNoChildrenIntersecting #91673 * 在 H3 中，使用平面 3D 数学从距离和方位角计算目标点" #93084 * 保护 H3 库免受整数溢出 #92829 * 减少 H3#h3 中的对象分配数量 地理边界 #91586 * 通过使用"FastMath"实现来加速 H3 库三角函数 #91839

Health

    

* 通过 xpack 公开运行状况 API 遥测数据 #91708(问题：#90877) * 运行状况 API 统计信息 #91559

索引接口

    

* 添加"ignore_missing_component_templates"配置选项 #92436(问题：#92426)

Infra/CLI

    

* 安装时扫描稳定插件中的命名组件 #92528

Infra/Core

    

* 为 JVM 日志添加日志级别 #92382 * 为队列操作添加了新字段"rollout_duration_seconds" #92640 * 将就绪服务绑定到通配符地址 #91329(问题：#90997) * 提供本地挂载的安全设置实现 #93392

Infra/Plugins

    

* 在安装和加载时检查稳定插件版本 #91780 * 具有设置的稳定插件示例 #92334 * 将稳定插件加载为合成模块 #91869 * 稳定插件的设置 API #91467

Infra/Scripting

    

* 脚本：元数据"验证元数据"优化 #93333 * 短路无痛定义平等 #92102 * 使用基元类型而不是装箱/拆箱来迭代 defs #92025 中的基元数组

采集节点

    

* 在日期处理器中缓存解析器的创建 #92880 * 使"GeoIpProcessor"支持数据库实例可插拔 #93285

机器学习

    

* 在异常解释中添加多模态分布的标识 #2440 * 添加在常用项目中包含和排除值的功能 #92414 * 滚动数据馈送中使用"aggregate_metric_double"时错误更好 #92232(问题：#90592) * 在常用项目中实现扩展修剪以提高运行时 #92322 * 使用全局序数提高"frequent_items"性能 #93304 * 提高异常检测结果索引速度 #92417 * 改进频繁项目运行时 #93255 * 增加启动训练模型部署 API 的默认超时 #92328 * 删除重置/删除作业 API 的用户添加注释的选项 #91698(问题：#74310) * 异步保留数据计数和数据馈送计时统计信息 #93000 * 删除现在在 Elasticsearch 中处理的 PyTorch 推理工作队列 #2456 * 文本嵌入搜索 #93531 * 将 PyTorch 升级到版本 1.13.1 #2430

Mapping

    

* 切换到 Lucene 的新 'IntField/LongField/FloatField/DoubleField' #93165

Monitoring

    

* 将kibana.stats.elasticsearch_client统计信息添加到监控索引模板中。#91508 * 为 es 引入指标集添加监控映射 #92950

Network

    

* 反序列化处理线程池上的响应 #91367

Performance

    

* 将矢量距离评分添加到微基准测试中 #92340

查询语言

    

* 引入参数化规则和执行器 #92428

Recovery

    

* 使清理文件步骤可配置为副本的对等恢复 #92490

Search

    

* 更高效地访问术语词典 #92269 * 为"rank_features"映射字段添加"术语"查询支持 #93247 * 在 knn 搜索子句中添加新的"query_vector_builder"选项 #93331 * 添加分析插件 #91640 * 默认启用分析插件 #92787 * 更并发获取堆栈帧和可执行文件 #93559 * 通过设置 7 个哈希函数提高布隆过滤器的误报率 #93283 * 增加 GET 线程池的线程数 #92309 * 仪器重量#计数在配置文件权重 #85656 (问题： #85203) * 减少匹配所有位集的内存使用量 #92777 * 运行时字段可选择忽略脚本错误 #92380 * 加快火焰图的数据检索 #93448 * 支持检索内联堆栈帧 #92863 * 分析] 降低气相色谱压力 [#93590

Security

    

* 无效或过期的 API 密钥的可配置保留期 #92219 * 记录 API 密钥失效时的时间戳 #91873

Snapshot/Restore

    

*使"恢复计划服务"可选#92489

TSDB

    

* 为 tsdb 索引中的"_id"字段启用布隆过滤器 #92115 * 通过删除地图查找来提高缩减采样性能 #92494(问题：#90226) * 轻微的 TSDB 解析加速 #92276 * 跳过对不包含文档时间戳的段的重复检查 #92456 * 在最后情况下支持合成源中的"字段" #91595

任务管理

    

* "TransportGetTaskAction："异步等待任务 #93375 * "TransportListTaskAction："等待任务异步完成 #90977(问题：#89564)

Transform

    

* 从参数添加到转换启动 API #91116(问题：#88646) * 支持"日期直方图组源"中的"偏移"参数 #93203 * 基于时间的触发状态持久性 #93221

矢量搜索

    

* 允许为"dense_vector"字段值提供"null" #93388 * 允许多个 KNN 搜索子句 #92118(问题：#91187)

Watcher

    

* 添加观察者的 Webhook 操作以发送其他标头的功能 #93426

### 新功能

Distributed

    

* 安全设置，可以回退到 yml 在无状态 #91925

Geo

    

* "geo_shape"字段 #91956 上的 Geohex 聚合(问题：#90163) * 支持geo_grid摄取处理器 #93370(问题：#92473)

Health

    

* 运行状况 API 现已正式发布 #92879 * 运行状况 API] 添加大小参数，用于控制返回的受影响资源数 [#92399(问题：#91930)* 运行状况 API] 添加对受影响FEATURE_STATE资源的支持 [#92296(问题：#91353)

Infra/Plugins

    

* 队列] 添加文件和文件数据索引模板和 ILM 策略 [#91413

采集节点

    

* 编辑摄取处理器 #92951

机器学习

    

* 使"frequent_item_sets"聚合 GA #93421 * 使本机推理正式发布 #92213

TSDB

    

* 添加 TSDB 速率聚合 #90447 * 缩减采样 GA #92913 * 将time_series和速率(在计数器字段上)聚合作为技术预览发布 #93546 * 时间序列 (TSDS) GA #91519

Transform

    

* 转换_schedule_now API #92948(问题：#44722)

###Upgrades

Infra/Core

    

* 将杰克逊的所有用法对齐为 2.14.2 #93438

采集节点

    

* 将 tika 升级到 2.6.0 #92104

Network

    

* 升级到 Netty 4.1.85 #91846 * 升级到 Netty 4.1.86 #92587

查询语言

    

* 将 antlr 升级到 4.11.1 for ql、eql 和 sql #93238

Search

    

* 升级到 Lucene 9.5.0 #93385 * 升级到 Lucene-9.5.0-snapshot-d19c3e2e0ed #92957

Snapshot/Restore

    

* 将 protobuf 的所有用法对齐为 3.21.9 #92123 * 凹凸反应器网络版本 #92457 * 将谷歌-oauth-客户端合并到最新版本 #91722

[« Elasticsearch version 8.7.1](release-notes-8.7.1.md) [Elasticsearch
version 8.6.2 »](release-notes-8.6.2.md)
