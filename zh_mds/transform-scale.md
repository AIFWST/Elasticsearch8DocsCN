

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[Roll up or
transform your data](data-rollup-transform.md) ›[Transforming
data](transforms.md)

[« Generating alerts for transforms](transform-alerts.md) [How transform
checkpoints work »](transform-checkpoints.md)

## 使用大规模转换

将现有的 Elasticsearch 索引转换为汇总索引，从而为新的见解和分析提供机会。转换执行的搜索和索引操作使用标准的 Elasticsearch 功能，因此大规模使用 Elasticsearch 的类似注意事项通常适用于转换。如果遇到性能问题，请首先确定瓶颈区域(搜索、索引、处理或存储)，然后查看本指南中的相关注意事项以提高性能。它还有助于了解转换的工作原理，因为不同的注意事项取决于转换是在连续模式下运行还是批量运行。

在本指南中，你将了解如何：

* 了解配置选项对转换性能的影响。

**Prerequisites:**

这些引导线假设您有一个要调整的转换，并且您已经熟悉：

* 转换如何工作。  * 如何设置转换。  * 转换检查点在连续模式下的工作方式。

以下注意事项不是连续的 - 数字有助于在列表项之间导航;您可以按任意顺序对其中的一个或多个执行操作。大多数建议适用于连续转换和批处理转换。如果列表项仅适用于一种转换类型，则说明中会突出显示此异常。

每个建议标题末尾括号中的关键字表示可以通过遵循给定的建议来改进的瓶颈区域。

#### 衡量转换性能

为了优化转换性能，请首先确定正在完成大多数工作的区域。Kibana 中转换页面的统计信息界面包含涵盖三个主要区域的信息：索引、搜索和处理时间(或者，您可以使用转换统计 API)。例如，如果结果显示花费在搜索上的时间比例最高，则优先优化转换的搜索查询。转换还具有 Rally 支持，如果需要，可以对转换配置运行性能检查。如果您优化了关键因素，但仍然遇到性能问题，您可能还需要考虑改进硬件。

#### 1\.优化"频率"(指数)

在连续转换中，"频率"配置选项设置检查源索引更改之间的间隔。如果检测到更改，则搜索源数据并将更改应用于目标索引。根据您的使用案例，您可能希望降低应用更改的频率。通过将"频率"设置为更高的值(最大值为一小时)，工作负载可以随着时间的推移而分散，但代价是最新数据较少。

#### 2\.增加目标索引(索引)的分片数量

根据目标索引的大小，您可以考虑增加其分片计数。默认情况下，转换在创建目标索引时使用一个分片。若要覆盖索引设置，请在开始转换之前创建目标索引。有关分片数量如何影响可扩展性和弹性的更多信息，请参阅 可扩展性和弹性

使用预览转换检查转换将用于创建目标索引的设置。您可以复制和调整这些索引，以便在开始转换之前创建目标索引。

#### 3\.分析和优化您的搜索查询(搜索)

如果已定义转换源索引"查询"，请确保其效率尽可能高。使用 InKibana 中的"开发工具"下的"搜索探查器"获取有关搜索请求中各个组件执行的详细计时信息。或者，您可以使用配置文件。通过结果，您可以深入了解搜索请求在低级别执行的方式，以便您可以了解某些请求运行缓慢的原因，并采取措施对其进行改进。

转换执行标准的 Elasticsearch 搜索请求。编写 Elasticsearch 查询有不同的方法，其中一些比其他方法更有效。请咨询搜索speed__Tune，以了解有关 Elasticsearch 性能调优的更多信息。

#### 4\.限制源查询的范围(搜索)

假设您的连续转换配置为按"IP"分组并计算"bytes_sent"的总和。对于每个检查点，连续转换会检测自上一个检查点以来源数据中的更改，从而标识已引入新数据的 IP。然后它执行第二次搜索，过滤这组IP，以计算总"bytes_sent"。如果第二次搜索与许多分片匹配，则这可能是资源密集型的。请考虑限制源索引模式和查询将匹配的范围。

在源查询中使用绝对时间值作为日期范围筛选器(例如，大于"2020-01-01T00：00：00")，以限制访问哪些历史索引。如果使用相对时间值(例如，"now-30d")，则会在每个检查点执行时重新评估此日期范围。

请考虑在索引名称中使用日期数学，以减少查询中要解析的索引数。将日期模式 \-例如，"yyyy-MM-dd" \- 添加到索引名称中，并使用它来将查询限制为特定日期。下面的示例仅查询昨天和今天的索引：

    
    
      "source": {
        "index": [
            "<mydata-{now/d-1d{yyyy-MM-dd}}*>",
            "<mydata-{now/d{yyyy-MM-dd}}*>"
        ]
      },

#### 5\.优化源索引分片策略(搜索)

没有放之四海而皆准的分片策略。在一个环境中有效的策略可能无法在另一个环境中扩展。一个好的分片策略必须考虑您的基础设施、用例和性能预期。

分片太少可能意味着无法实现分配工作负载的好处;但是，过多的分片可能会影响集群运行状况。要了解有关调整分片大小的更多信息，请阅读本指南。

#### 6\.调整"max_page_search_size"(搜索)

"max_page_search_size"转换配置选项定义为每个搜索请求返回的存储桶数。默认值为 500。如果增加此值，则会以更高的延迟和内存使用率为代价获得更好的吞吐量。

此参数的理想值高度取决于您的使用案例。如果转换执行内存密集型聚合(例如，基数或百分位数)，则增加"max_page_search_size"需要更多的可用内存。如果超出内存限制，则会发生断路器异常。

#### 7\.在源索引中使用索引字段(搜索)

运行时字段和脚本化字段不是索引字段;它们的值仅在搜索时提取或计算。虽然这些字段提供了访问数据的灵活性，但它们会增加搜索时间的性能成本。如果担心使用运行时字段或脚本化字段转换性能，则不妨考虑改用索引字段。出于性能原因，我们不建议使用运行时字段作为同步连续转换的时间字段。

#### 8\.使用索引排序(搜索，处理)

索引排序支持将文档按特定顺序存储在磁盘上，从而提高查询效率。理想的排序逻辑取决于您的用例，但经验法则可能是从基于时间的字段开始按降序(从高到低基数)对字段进行排序。索引排序只能在创建索引时定义一次。如果要用作源的索引上还没有索引排序，请考虑将其重新索引为新的排序索引。

#### 9\.禁用目标索引(存储)上的"_source"字段

"_source"字段包含在索引时传递的原始 JSON 文档正文。"_source"字段本身未编制索引(因此不可搜索)，但它仍存储在索引中并产生存储开销。如果目标索引较大，请考虑禁用"_source"以节省存储空间。禁用"_source"只能在创建索引期间进行。

禁用"_source"字段时，不支持许多功能。在禁用之前，请参阅禁用"_source"字段以了解后果。

#### 延伸阅读

* 搜索speed__Tune * _Tune索引speed_ * _Size shards_ * 索引生命周期

[« Generating alerts for transforms](transform-alerts.md) [How transform
checkpoints work »](transform-checkpoints.md)
