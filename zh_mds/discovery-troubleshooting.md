

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md)
›[Troubleshooting](troubleshooting.md)

[« Addressing repeated snapshot policy failures](repeated-snapshot-
failures.md) [Troubleshooting monitoring »](monitoring-troubleshooting.md)

## 疑难解答发现

在大多数情况下，发现和选举过程会很快完成，并且主节点在很长一段时间内保持选中状态。

如果您的集群没有稳定的主节点，其许多功能将无法正常工作，Elasticsearch 将向客户端及其日志报告错误。在解决这些其他问题之前，您必须修复主节点的不稳定性。如果没有选定的主节点或选定的主节点不稳定，则无法解决任何其他问题。

如果您的集群具有稳定的主节点，但某些节点无法发现或加入它，则这些节点将向客户端及其日志报告错误。在解决其他问题之前，必须解决阻止这些节点加入群集的障碍。当这些节点无法加入群集时，将无法解决任何其他问题报告的问题。

如果集群没有选择的主节点超过几秒钟，主节点不稳定，或者某些节点无法发现或加入稳定主节点，那么 Elasticsearch 将在其日志中记录信息来解释原因。如果问题持续超过几分钟，Elasticsearch 将在其日志中记录其他信息。要正确排查发现和选举问题，请从所有节点收集和分析至少五分钟的日志。

以下各节介绍一些常见的发现和选择问题。

### 未选择主控

当节点赢得主节点选举时，它会记录一条包含"当选为主节点"的消息，所有节点都会记录一条包含"主节点已更改"的消息，以标识新当选的主节点。

如果没有选定的主节点，并且没有节点可以赢得选举，则所有节点将使用名为"org.elasticsearch.cluster.coordination.ClusterFormationFailureHelper"的记录器重复记录有关问题的消息。默认情况下，这种情况每 10 秒发生一次。

主节点选举仅涉及符合主节点条件的节点，因此在这种情况下，请将注意力集中在符合主节点条件的节点上。这些节点的日志将指示主选举的要求，例如发现一组特定的节点。这些节点上的运行状况 API 还将提供有关情况的有用信息。

如果日志或运行状况报告表明 Elasticsearch 无法发现足够的节点来形成仲裁，则必须解决阻止 Elasticsearch 发现缺失节点的原因。需要缺少的节点来重建群集元数据。如果没有集群元数据，集群中的数据将毫无意义。群集元数据存储在群集中符合主节点条件的节点子集上。如果无法发现仲裁，则缺少的节点是保存群集元数据的节点。

确保有足够的节点正在运行以形成仲裁，并且每个节点都可以通过网络与其他节点通信。如果选举问题持续超过几分钟，Elasticsearch 将报告有关网络连接的其他详细信息。如果无法启动足够的节点来形成仲裁，请启动新群集并从最近的快照还原数据。有关详细信息，请参阅基于仲裁的决策。

如果日志或运行状况报告指示 Elasticsearch _has_ 发现了可能的节点仲裁，则集群无法选择 amaster 的典型原因是其他节点之一无法发现仲裁。检查其他符合主节点条件的节点上的日志，并确保它们都发现了足够的节点来形成仲裁。

如果日志表明发现或主选择由于超时或网络相关问题而失败，则按如下方式缩小问题范围。

* GC 暂停记录在 Elasticsearch 默认发出的 GC 日志中，通常也记录在主节点日志中的"JvmMonitorService"中。使用这些日志确认 GC 是否会导致延迟。  * VM 暂停也会影响同一主机上的其他进程。虚拟机暂停通常也会导致系统时钟的不连续性，Elasticsearch 将在其日志中报告。  * 数据包捕获将显示系统级和网络级故障，尤其是在所有相关节点上同时捕获网络流量时。您应该能够观察到节点之间连接的任何重新传输、数据包丢失或其他延迟。  * 特定线程可用的长时间等待可以通过在相关日志消息之前的几秒钟内进行堆栈转储(例如，使用"jstack")或分析跟踪(例如，使用 Java Flight Recorder)来识别。

节点热线程 API 有时会生成有用的信息，但请记住，此 API 还需要跨群集中所有节点的"transport_worker"和"泛型"线程。API 可能会受到您重新尝试诊断的问题的影响。"jstack"更可靠，因为它不需要任何JVM线程。

发现和群集成员资格中涉及的线程主要是"transport_worker"和"cluster_coordination"线程，这些线程不应该有很长的等待时间。在 Elasticsearch 日志中，也可能有长时间等待线程的证据。有关详细信息，请参阅网络线程模型。

### 大师当选但不稳定

当节点赢得主节点选举时，它会记录一条包含"当选为主节点"的消息。如果这种情况反复发生，则选定的主节点不稳定。在这种情况下，请关注来自符合主节点条件的节点的日志，以了解为什么选举获胜者不再是主节点并触发另一个选举。如果日志表明主服务器由于超时或网络相关问题而不稳定，则按如下方式缩小问题范围。

* GC 暂停记录在 Elasticsearch 默认发出的 GC 日志中，通常也记录在主节点日志中的"JvmMonitorService"中。使用这些日志确认 GC 是否会导致延迟。  * VM 暂停也会影响同一主机上的其他进程。虚拟机暂停通常也会导致系统时钟的不连续性，Elasticsearch 将在其日志中报告。  * 数据包捕获将显示系统级和网络级故障，尤其是在所有相关节点上同时捕获网络流量时。您应该能够观察到节点之间连接的任何重新传输、数据包丢失或其他延迟。  * 特定线程可用的长时间等待可以通过在相关日志消息之前的几秒钟内进行堆栈转储(例如，使用"jstack")或分析跟踪(例如，使用 Java Flight Recorder)来识别。

节点热线程 API 有时会生成有用的信息，但请记住，此 API 还需要跨群集中所有节点的"transport_worker"和"泛型"线程。API 可能会受到您重新尝试诊断的问题的影响。"jstack"更可靠，因为它不需要任何JVM线程。

发现和群集成员资格中涉及的线程主要是"transport_worker"和"cluster_coordination"线程，这些线程不应该有很长的等待时间。在 Elasticsearch 日志中，也可能有长时间等待线程的证据。有关详细信息，请参阅网络线程模型。

### 节点无法发现或加入稳定主节点

如果有一个稳定的选定主节点，但节点无法发现或加入其集群，它将使用"ClusterFormationFailureHelper"记录器重复记录有关问题的消息。受影响节点上的运行状况 API 还将提供有关情况的有用信息。受影响节点和选定主节点上的其他日志消息可能会提供有关该问题的其他信息。如果日志表明该节点由于超时或网络相关问题而无法发现或加入群集，则按如下方式缩小问题范围。

* GC 暂停记录在 Elasticsearch 默认发出的 GC 日志中，通常也记录在主节点日志中的"JvmMonitorService"中。使用这些日志确认 GC 是否会导致延迟。  * VM 暂停也会影响同一主机上的其他进程。虚拟机暂停通常也会导致系统时钟的不连续性，Elasticsearch 将在其日志中报告。  * 数据包捕获将显示系统级和网络级故障，尤其是在所有相关节点上同时捕获网络流量时。您应该能够观察到节点之间连接的任何重新传输、数据包丢失或其他延迟。  * 特定线程可用的长时间等待可以通过在相关日志消息之前的几秒钟内进行堆栈转储(例如，使用"jstack")或分析跟踪(例如，使用 Java Flight Recorder)来识别。

节点热线程 API 有时会生成有用的信息，但请记住，此 API 还需要跨群集中所有节点的"transport_worker"和"泛型"线程。API 可能会受到您重新尝试诊断的问题的影响。"jstack"更可靠，因为它不需要任何JVM线程。

发现和群集成员资格中涉及的线程主要是"transport_worker"和"cluster_coordination"线程，这些线程不应该有很长的等待时间。在 Elasticsearch 日志中，也可能有长时间等待线程的证据。有关详细信息，请参阅网络线程模型。

### 节点加入集群并再次离开

如果一个节点加入了集群，但 Elasticsearch 确定它是有故障的，那么它将再次从集群中删除。有关更多信息，请参阅排查不稳定集群问题。

[« Addressing repeated snapshot policy failures](repeated-snapshot-
failures.md) [Troubleshooting monitoring »](monitoring-troubleshooting.md)
