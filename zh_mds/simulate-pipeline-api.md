

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[REST
APIs](rest-apis.md) ›[Ingest APIs](ingest-apis.md)

[« Get pipeline API](get-pipeline-api.md) [Info API »](info-api.md)

## 模拟流水线API

针对一组提供的文档执行引入管道。

    
    
    POST /_ingest/pipeline/my-pipeline-id/_simulate
    {
      "docs": [
        {
          "_index": "index",
          "_id": "id",
          "_source": {
            "foo": "bar"
          }
        },
        {
          "_index": "index",
          "_id": "id",
          "_source": {
            "foo": "rab"
          }
        }
      ]
    }

###Request

'POST /_ingest/pipeline/<pipeline>/_simulate'

'GET /_ingest/pipeline/<pipeline>/_simulate'

'POST /_ingest/pipeline/_simulate'

'GET /_ingest/pipeline/_simulate'

###Prerequisites

* 如果启用了 Elasticsearch 安全功能，您必须具有"read_pipeline"、"manage_pipeline"、"manage_ingest_pipelines"或"管理"集群权限才能使用此 API。

###Description

模拟管道 API 针对请求正文中提供的一组文档执行特定管道。

您可以指定要针对提供的文档执行的现有管道，也可以在请求正文中提供管道定义。

### 路径参数

`<pipeline>`

     (Required*, string) Pipeline to test. If you don't specify a `pipeline` in the request body, this parameter is required. 

### 查询参数

`verbose`

     (Optional, Boolean) If `true`, the response includes output data for each processor in the executed pipeline. 

### 请求正文

`pipeline`

    

(必填*，对象)要测试的管道。如果未指定"<pipeline>请求路径"参数，则此参数是必需的。如果同时指定 this 和请求路径参数，则 API 仅使用请求路径参数。

"管道"的属性

`description`

     (Optional, string) Description of the ingest pipeline. 
`on_failure`

    

(可选，处理器对象数组)处理器在处理器故障后立即运行。

每个处理器都支持处理器级别的"on_failure"值。如果没有"on_failure"值的处理器发生故障，Elasticsearch 会使用此管道级参数作为回退。此参数中的处理器按指定的顺序按顺序运行。Elasticsearch 不会尝试运行管道的剩余处理器。

`processors`

     (Required, array of [processor](processors.html "Ingest processor reference") objects) Processors used to perform transformations on documents before indexing. Processors run sequentially in the order specified. 
`version`

    

(可选，整数)外部系统用于跟踪引入管道的版本号。

请参阅上面的"if_version"参数，了解如何使用版本属性。

`_meta`

     (Optional, object) Optional metadata about the ingest pipeline. May have any contents. This map is not automatically generated by Elasticsearch. 

`docs`

    

(必需，对象数组)要在管道中测试的示例文档。

"文档"对象的属性

`_id`

     (Optional, string) Unique identifier for the document. This ID must be unique within the `_index`. 
`_index`

     (Optional, string) Name of the index containing the document. 
`_routing`

     (Optional, string) Value used to send the document to a specific primary shard. See the [`_routing`](mapping-routing-field.html "_routing field") field. 
`_source`

     (Required, object) JSON body for the document. 

###Examples

#### 将管道指定为路径参数

    
    
    POST /_ingest/pipeline/my-pipeline-id/_simulate
    {
      "docs": [
        {
          "_index": "index",
          "_id": "id",
          "_source": {
            "foo": "bar"
          }
        },
        {
          "_index": "index",
          "_id": "id",
          "_source": {
            "foo": "rab"
          }
        }
      ]
    }

API 返回以下响应：

    
    
    {
       "docs": [
          {
             "doc": {
                "_id": "id",
                "_index": "index",
                "_version": "-3",
                "_source": {
                   "field2": "_value",
                   "foo": "bar"
                },
                "_ingest": {
                   "timestamp": "2017-05-04T22:30:03.187Z"
                }
             }
          },
          {
             "doc": {
                "_id": "id",
                "_index": "index",
                "_version": "-3",
                "_source": {
                   "field2": "_value",
                   "foo": "rab"
                },
                "_ingest": {
                   "timestamp": "2017-05-04T22:30:03.188Z"
                }
             }
          }
       ]
    }

#### 在请求正文中指定管道

    
    
    response = client.ingest.simulate(
      body: {
        pipeline: {
          description: '_description',
          processors: [
            {
              set: {
                field: 'field2',
                value: '_value'
              }
            }
          ]
        },
        docs: [
          {
            _index: 'index',
            _id: 'id',
            _source: {
              foo: 'bar'
            }
          },
          {
            _index: 'index',
            _id: 'id',
            _source: {
              foo: 'rab'
            }
          }
        ]
      }
    )
    puts response
    
    
    POST /_ingest/pipeline/_simulate
    {
      "pipeline" :
      {
        "description": "_description",
        "processors": [
          {
            "set" : {
              "field" : "field2",
              "value" : "_value"
            }
          }
        ]
      },
      "docs": [
        {
          "_index": "index",
          "_id": "id",
          "_source": {
            "foo": "bar"
          }
        },
        {
          "_index": "index",
          "_id": "id",
          "_source": {
            "foo": "rab"
          }
        }
      ]
    }

API 返回以下响应：

    
    
    {
       "docs": [
          {
             "doc": {
                "_id": "id",
                "_index": "index",
                "_version": "-3",
                "_source": {
                   "field2": "_value",
                   "foo": "bar"
                },
                "_ingest": {
                   "timestamp": "2017-05-04T22:30:03.187Z"
                }
             }
          },
          {
             "doc": {
                "_id": "id",
                "_index": "index",
                "_version": "-3",
                "_source": {
                   "field2": "_value",
                   "foo": "rab"
                },
                "_ingest": {
                   "timestamp": "2017-05-04T22:30:03.188Z"
                }
             }
          }
       ]
    }

#### 查看详细结果

可以使用模拟管道 API 查看每个处理器在通过管道时如何影响最引入的文档。要查看模拟请求中每个处理器的中间结果，可以将"verbose"参数添加到请求中。

    
    
    response = client.ingest.simulate(
      verbose: true,
      body: {
        pipeline: {
          description: '_description',
          processors: [
            {
              set: {
                field: 'field2',
                value: '_value2'
              }
            },
            {
              set: {
                field: 'field3',
                value: '_value3'
              }
            }
          ]
        },
        docs: [
          {
            _index: 'index',
            _id: 'id',
            _source: {
              foo: 'bar'
            }
          },
          {
            _index: 'index',
            _id: 'id',
            _source: {
              foo: 'rab'
            }
          }
        ]
      }
    )
    puts response
    
    
    POST /_ingest/pipeline/_simulate?verbose=true
    {
      "pipeline" :
      {
        "description": "_description",
        "processors": [
          {
            "set" : {
              "field" : "field2",
              "value" : "_value2"
            }
          },
          {
            "set" : {
              "field" : "field3",
              "value" : "_value3"
            }
          }
        ]
      },
      "docs": [
        {
          "_index": "index",
          "_id": "id",
          "_source": {
            "foo": "bar"
          }
        },
        {
          "_index": "index",
          "_id": "id",
          "_source": {
            "foo": "rab"
          }
        }
      ]
    }

API 返回以下响应：

    
    
    {
      "docs" : [
        {
          "processor_results" : [
            {
              "processor_type" : "set",
              "status" : "success",
              "doc" : {
                "_index" : "index",
                "_id" : "id",
                "_version": "-3",
                "_source" : {
                  "field2" : "_value2",
                  "foo" : "bar"
                },
                "_ingest" : {
                  "pipeline" : "_simulate_pipeline",
                  "timestamp" : "2020-07-30T01:21:24.251836Z"
                }
              }
            },
            {
              "processor_type" : "set",
              "status" : "success",
              "doc" : {
                "_index" : "index",
                "_id" : "id",
                "_version": "-3",
                "_source" : {
                  "field3" : "_value3",
                  "field2" : "_value2",
                  "foo" : "bar"
                },
                "_ingest" : {
                  "pipeline" : "_simulate_pipeline",
                  "timestamp" : "2020-07-30T01:21:24.251836Z"
                }
              }
            }
          ]
        },
        {
          "processor_results" : [
            {
              "processor_type" : "set",
              "status" : "success",
              "doc" : {
                "_index" : "index",
                "_id" : "id",
                "_version": "-3",
                "_source" : {
                  "field2" : "_value2",
                  "foo" : "rab"
                },
                "_ingest" : {
                  "pipeline" : "_simulate_pipeline",
                  "timestamp" : "2020-07-30T01:21:24.251863Z"
                }
              }
            },
            {
              "processor_type" : "set",
              "status" : "success",
              "doc" : {
                "_index" : "index",
                "_id" : "id",
                "_version": "-3",
                "_source" : {
                  "field3" : "_value3",
                  "field2" : "_value2",
                  "foo" : "rab"
                },
                "_ingest" : {
                  "pipeline" : "_simulate_pipeline",
                  "timestamp" : "2020-07-30T01:21:24.251863Z"
                }
              }
            }
          ]
        }
      ]
    }

[« Get pipeline API](get-pipeline-api.md) [Info API »](info-api.md)
