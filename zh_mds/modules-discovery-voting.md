

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[Set up
Elasticsearch](setup.md) ›[Discovery and cluster formation](modules-
discovery.md)

[« Quorum-based decision making](modules-discovery-quorums.md)
[Bootstrapping a cluster »](modules-discovery-bootstrap-cluster.md)

## 投票配置

每个 Elasticsearch 集群都有一个_voting configuration_，它是一组符合主节点条件的节点，在做出诸如选举新主节点或提交新集群状态等决策时，会计算其响应。只有在投票配置中的大多数(超过一半)节点响应后，才会做出决定。

通常，投票配置与群集中当前所有符合主节点条件的节点集相同。但是，在某些情况下，它们可能会有所不同。

为确保群集保持可用，您不得同时停止投票配置中的一半或更多节点**。只要超过一半的投票节点可用，集群就可以正常工作。例如，如果有三个或四个符合主节点条件的节点，则群集可以容忍一个不可用的节点。如果有两个或更少的主节点，则它们必须全部保持可用。

节点加入或离开集群后，Elasticsearch 会通过自动对投票配置进行相应的更改来做出反应，以确保集群尽可能具有弹性。请务必等待此调整完成，然后再从群集中删除更多节点。有关详细信息，请参阅yourcluster_中的_Add和删除节点。

当前投票配置存储在群集状态中，因此您可以按如下方式检查其当前内容：

    
    
    response = client.cluster.state(
      filter_path: 'metadata.cluster_coordination.last_committed_config'
    )
    puts response
    
    
    GET /_cluster/state?filter_path=metadata.cluster_coordination.last_committed_config

当前投票配置不一定与群集中所有可用的符合主节点条件的节点集相同。更改投票配置涉及投票，因此当节点加入或离开群集时，需要一些时间来调整配置。此外，在某些情况下，最具复原能力的配置包括不可用的节点或不包括某些可用节点。在这些情况下，投票配置与群集中可用的符合主节点条件的节点集不同。

较大的投票配置通常更具弹性，因此 Elasticsearch 通常更喜欢在节点加入集群后将符合主节点条件的节点添加到投票配置中。同样，如果投票配置中的节点离开集群，并且集群中还有另一个不符合主节点条件的节点不在投票配置中，则最好交换这两个节点。因此，投票配置的大小保持不变，但其弹性增加。

在节点离开集群后自动从投票配置中删除节点并不是那么简单。不同的策略有不同的优点和缺点，因此正确的选择取决于集群的使用方式。您可以使用"cluster.auto_shrink_voting_configuration"设置控制投票配置是否自动收缩。

如果"cluster.auto_shrink_voting_configuration"设置为"true"(这是默认值和推荐值)，并且集群中至少有三个符合主节点条件的节点，则只要除一个符合主节点条件的节点外，Elasticsearch 仍然能够处理集群状态更新。

在某些情况下，Elasticsearch 可能会容忍多个节点的丢失，但不能保证在所有故障序列下都这样做。如果"cluster.auto_shrink_voting_configuration"设置为"false"，则必须手动从投票配置中删除已离开的节点。使用投票排除 API 实现所需的复原级别。

无论如何配置，Elasticsearch 都不会遭受"裂脑"不一致的困扰。"cluster.auto_shrink_voting_configuration"设置仅影响其某些节点发生故障时的可用性，以及节点加入和离开群集时必须执行的管理任务。

#### 偶数个主节点

集群中通常应该有奇数个符合主节点条件的节点。如果存在偶数，Elasticsearch 会将其中一个排除在投票配置之外，以确保它具有奇数大小。此省略不会降低群集的容错能力。事实上，它略有改进：如果集群遭受网络分区的困扰，该分区将其分成大小相等的两半，那么其中一半将包含大多数投票配置，并且能够继续运行。如果计算来自符合主条件节点的所有投票，则任何一方都不会包含严格多数的节点，因此集群将无法取得任何进展。

例如，如果群集中有四个符合主节点条件的节点，并且投票配置包含所有这些节点，则任何基于仲裁的决策都需要其中至少三个节点的投票。这种情况意味着集群只能容忍丢失一个符合主节点条件的节点。如果将此群集分成两个相等的半部分，则任何一半都不会包含三个符合主节点条件的节点，并且群集将无法取得任何进展。但是，如果投票配置仅包含四个符合主节点条件的节点中的三个，则集群仍然只能完全容忍一个节点的丢失，但基于仲裁的决策需要三个投票节点中的两个投票。在平均拆分的情况下，一半将包含三个投票节点中的两个，以便一半保持可用。

#### 设置初始投票配置

当一个全新的集群首次启动时，它必须选择其第一个主节点。要进行此选举，它需要知道哪些主节点的选票应该计算在内。此初始投票配置称为_bootstrap configuration_，在群集引导过程中设置。

引导程序配置必须准确识别哪些节点应该在第一次选举中投票，这一点很重要。仅仅配置每个节点并期望群集中应有多少个节点是不够的。同样重要的是要注意，引导程序配置必须来自集群外部：集群没有安全的方法可以自行正确确定引导程序配置。

如果引导程序配置设置不正确，则在启动全新集群时，可能会意外形成两个单独的集群，而不是一个。这种情况可能会导致数据丢失：您可能会在注意到出现任何问题之前开始使用这两个集群，并且以后无法将它们合并在一起。

为了说明将每个节点配置为预期特定群集大小的问题，请假设启动一个三节点群集，其中每个节点都知道它将成为三节点群集的一部分。三个节点的大多数是两个，所以通常前两个相互发现的节点形成一个集群，第三个节点在短时间内加入它们。但是，想象一下错误地启动了四个节点而不是三个节点。在这种情况下，有足够的节点形成两个单独的集群。当然，如果每个节点都是手动启动的，那么不太可能启动太多节点。但是，如果要重用自动业务流程协调程序，则肯定有可能遇到这种情况，尤其是在业务流程协调程序无法复原故障(如网络分区)的情况下。

仅在整个群集首次启动时才需要初始仲裁。加入已建立集群的新节点可以安全地从选定的主节点获取所需的所有信息。以前属于群集的节点将重新启动时所需的所有信息存储到磁盘中。

[« Quorum-based decision making](modules-discovery-quorums.md)
[Bootstrapping a cluster »](modules-discovery-bootstrap-cluster.md)
