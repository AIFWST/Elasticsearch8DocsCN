

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[Roll up or
transform your data](data-rollup-transform.md) ›[Transforming
data](transforms.md)

[« Painless examples for transforms](transform-painless-examples.md) [Set up
a cluster for high availability »](high-availability.md)

## 转换限制

以下限制和已知问题适用于 Elastic 变换功能的 8.9.0 版本。这些限制分为以下几类：

* 配置限制适用于转换的配置过程。  * 操作限制会影响正在运行的转换的行为。  * Kibana 中的限制仅适用于通过用户界面管理的转换。

#### 配置限制

##### 以下划线为前缀的字段名称在最新转换中省略

如果使用"最新"类型的转换，并且源索引具有以下划线 (_) 字符开头的字段名称，则假定它们是内部字段。目标索引中的文档中省略这些字段。

##### 转换支持跨集群搜索(如果远程群集配置正确)

如果使用跨集群搜索，则远程集群必须支持您在转换中使用的搜索和聚合。转换验证其配置;如果使用跨集群搜索并且验证失败，请确保远程集群支持您使用的查询和聚合。

##### 使用脚本进行转换

当聚合支持转换时，转换在每种情况下都支持脚本。但是，在转换中使用脚本时，您可能需要考虑某些因素：

* 当脚本创建输出字段时，转换无法推断输出字段的索引映射。在这种情况下，您可能希望在创建转换之前自行创建目标索引的映射。  * 脚本化字段可能会增加转换的运行时间。  * 当您对"group_by"中定义的所有分组使用脚本时，转换无法优化查询，当您以这种方式使用脚本时，您将收到一条警告消息。

##### 无痛脚本转换的弃用警告

如果转换包含使用已弃用语法的无痛脚本，则在预览或启动转换时会显示弃用警告。但是，无法将 allTransform 中的弃用警告作为批量操作进行检查，因为运行所需的查询可能是资源密集型过程。因此，由于已弃用的无痛语法而导致的任何弃用警告在升级助手中不可用。

##### 转换在索引字段上性能更好

按用户定义的时间字段转换排序数据，该时间字段经常访问。如果时间字段是运行时字段，则在查询时计算字段值的性能影响可能会显著减慢转换速度。使用转换时，使用索引字段作为时间字段。

##### 连续转换调度限制

连续转换会定期检查源数据的更改。调度程序的功能目前仅限于基本的周期性计时器它可以在 1s 到 1h 的"频率"范围内。默认值为 1m。这旨在很少且经常运行。为此计时器选择"频率"时，请考虑您的引入速率以及转换搜索/索引操作对集群中其他用户的影响。另请注意，重试以"频率"间隔发生。

#### 操作限制

##### 聚合响应可能与目标索引映射不兼容

首次启动透视转换时，它将推断目标索引所需的映射。此过程基于源索引的字段类型和使用的聚合。如果字段派生自"scripted_metrics"或"bucket_scripts"，则将使用动态映射。在某些情况下，推导的映射可能与实际数据不兼容。例如，可能会发生数字溢出，或者动态映射字段可能包含数字和字符串。请检查 Elasticsearch 日志如果您认为可能已经发生了这种情况。

可以使用预览版转换 API 查看推导的映射。请参阅 API 响应中的"generated_dest_index"对象。

如果需要，可以在开始转换之前定义自定义映射，方法是使用创建索引 API 创建自定义目标索引。由于推导的映射无法被索引模板覆盖，因此请使用创建索引 API 定义自定义映射。索引模板仅适用于从使用动态映射的脚本派生的字段。

##### 批量转换可能无法解释更改的文档

批量转换使用复合聚合，允许对所有存储桶进行高效分页。复合聚合尚不支持搜索上下文，因此，如果在批处理数据框正在进行时更改(删除、更新、添加)源数据，则结果可能不包含这些更改。

##### 连续转换一致性不考虑已删除或更新的文档

虽然转换过程允许在引入新数据时不断重新计算转换，但它也有一些限制。

仅当更改的实体的时间字段也已更新且位于检查更改的操作范围内时，才会标识已更改的实体。这原则上是为 newdata 提供摄取时间时间戳的用例而设计的，并且适用于这种情况。

如果删除了属于源索引模式范围内的索引(例如，在删除基于时间的历史索引时)，则在连续检查点处理中执行的复合聚合将搜索不同的源数据，并且仅存在于已删除索引中的实体将不会从数据框目标索引中删除。

根据您的使用案例，您可能希望在删除后完全重新创建转换。或者，如果您的使用案例容忍历史存档，您可能希望在聚合中包含最大摄取时间戳。这将允许您在查看目标索引时排除最近未更新的结果。

##### 删除转换不会删除目标索引或 Kibana索引模式

使用"DELETE _transform/index"删除转换时，目标索引和 Kibana 索引模式(如果已创建)都不会被删除。必须单独删除这些对象。

##### 处理聚合页面大小的动态调整

在转换的开发过程中，控制比性能更受青睐。在设计注意事项中，转换最好在后台安静地完成，而不是快速完成并优先于资源消耗。

复合聚合非常适合高基数数据，通过结果实现分页。如果在执行复合聚合搜索时发生断路器内存异常，则我们再次尝试减少请求的存储桶数。此断路器是根据群集内的所有活动(而不仅仅是来自转换的活动)计算的，因此它可能只是一个临时资源可用性问题。

对于批量转换，请求的存储桶数只会向下调整。值的降低可能会导致转换检查点完成的持续时间更长。对于连续转换，请求的存储桶数量在每个检查点开始时重置回默认值，并且断路器异常可能会在 Elasticsearch 日志中重复发生。

转换批量检索数据，这意味着它一次计算多个存储桶。默认情况下，每个搜索/索引操作 500 个存储桶。可以使用"max_page_search_size"更改默认值，最小值为 10。如果在请求的存储桶数减少到最小值后仍然发生故障，则转换将设置为失败状态。

##### 处理多个项的动态调整

对于每个检查点，标识自上次执行检查以来已更改的实体。此已更改实体列表作为术语查询提供给转换复合聚合，一次一页。然后，将更新应用于实体的每一页的目标索引。

页面"size"由"max_page_search_size"定义，该"也用于定义复合聚合搜索返回的存储桶数。默认值为 500，最小值为 10。

索引设置"index.max_terms_count"定义了可以在术语查询中使用的最大术语数。默认值为 65536。如果"max_page_search_size"超过"index.max_terms_count"，则转换将失败。

对"max_page_search_size"使用较小的值可能会导致转换检查点完成的持续时间更长。

##### 失败转换的处理

失败的转换仍作为持久性任务，应通过删除它或解决失败的根本原因并重新启动来适当地处理。

使用 API 删除失败的转换时，首先使用"_stop？force=true"将其停止，然后将其删除。

##### 如果文档尚不可用，连续转换可能会给出不正确的结果

为文档编制索引后，在可供搜索之前会有非常小的延迟。

连续转换会定期检查自上次检查以来的时间与"现在"减去"sync.time.delay"之间的更改实体。此时间窗口移动而不重叠。如果最近编制索引的文档的时间戳在此时间范围内，但此文档尚不可用于搜索，则不会更新此实体。

如果使用表示数据摄取时间的"sync.time.field"并使用零秒或非常小的"sync.time.delay"，则更有可能发生此问题。

##### 支持日期纳秒数据类型

如果数据使用日期纳秒数据类型，则聚合仍采用毫秒分辨率。此限制还会影响转换中的聚合。

##### 不支持数据流作为目标索引

转换目标索引中需要写入目标的更新数据。_Data streams_设计为仅追加，这意味着您无法将更新或删除请求直接发送到数据流。因此，不支持将数据流作为转换的目标索引。

##### ILM 作为目标索引可能会导致文档重复

不建议将 ILM 用作转换目标索引。转换当前目标中的更新文档，并且不能删除 ILM 以前使用的索引中的文档。当您将转换与 ILM 结合使用时，这可能会导致文档重复，以防滚动更新。

如果使用 ILM 来建立基于时间的索引，请考虑改用日期索引名称。如果转换包含基于"date_histogram"的"group_by"，则处理器在没有重复文档的情况下工作。

#### Kibana 中的限制

##### 变换在所有 Kibanaspaces 中可见

使用空间，您可以在 Kibana 中组织源索引和目标索引以及其他已保存的对象，并仅查看属于空间的对象。但是，转换是一个长时间运行的任务，在群集级别进行管理，因此不限于某些空间的范围。可以在 Kibana** 的堆栈管理**下为数据视图实现空间感知>这允许对转换目标索引的权限。

##### Kibana 中最多列出 1，000 个转换

Kibana 中的转换管理页面最多列出了 1000 个转换。

##### Kibana 可能不支持每个转换配置选项

可能有一些配置选项可以通过转换 API 提供，而这些选项在 Kibana 中不受支持。有关配置选项的详尽列表，请参阅文档。

[« Painless examples for transforms](transform-painless-examples.md) [Set up
a cluster for high availability »](high-availability.md)
