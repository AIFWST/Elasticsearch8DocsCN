

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md)
›[Troubleshooting](troubleshooting.md) ›[Fix common cluster issues](fix-
common-cluster-issues.md)

[« Task queue backlog](task-queue-backlog.md) [Hot spotting
»](hotspotting.md)

## 映射爆炸

Elasticsearch 的搜索和 Kibana 的 discovery Javascript 渲染依赖于搜索的支持索引，即所有映射深度的映射字段总数。当这个总量太高或呈指数级攀升时，我们将其称为经历映射爆炸。如此高的字段计数并不常见，通常表明上游文档格式问题，如本博客所示。

映射爆炸可能表现为以下性能症状：

* CAT 节点在主节点和/或托管索引分片的节点上报告高堆或 CPU。这可能会升级为临时节点无响应和/或主不堪重负。  * CAT 任务报告仅与此索引相关的较长搜索持续时间，即使在简单搜索中也是如此。  * 仅与此索引相关的较长索引持续时间的 CAT 任务。这通常与报告协调节点正在等待所有其他节点确认它们正在映射更新请求的待处理任务有关。  * Discover的"通配符**"页面加载API命令或开发工具页面刷新自动完成API命令的字段需要很长时间(超过10秒)或在浏览器的"开发人员工具网络"选项卡中超时。  * 发现的**可用字段**需要很长时间才能在浏览器的开发人员工具性能选项卡中编译Javascript。这可能会升级为浏览器页面暂时无响应。  * Kibana 的警报或安全规则可能会出错"内容长度 (X) 大于允许的最大字符串 (Y)"，其中"X"是尝试有效负载，"Y"是 Kibana 的"服务器最大有效负载"。  * Elasticsearch启动时间较长。

#### 防止或准备

映射初始化后无法减少字段。Elasticsearch 索引默认为动态映射，除非它与覆盖"index.mapping.total_fields.limit"结合使用，否则通常不会引起问题。默认的"1000"限制被认为是慷慨的，尽管根据用例，覆盖到"10000"不会造成明显的影响。但是，举一个不好的例子，覆盖到"100000"并且映射总数会达到此限制通常会对性能产生很大影响。

如果您的索引映射字段希望包含大量任意键集，则可以改为考虑：

* 使用平展数据类型。但请注意，Kibana 尚不完全支持展平对象。例如，这可以应用于子映射，如 { 'host.name' ， 'host.os'， 'host.version' }。运行时字段仍可访问所需字段。  * 使用对象数据类型。当您对存储而不是搜索一组字段感兴趣时，这非常有用。这通常用于未知的上游场景，这些场景可能会引起许多字段。例如，当子映射开始显示新的意外字段(如 { 'o365.a01'、'o365.a02'、'o365.b01'、'o365.c99'})时，建议这样做。  * 设置"index：false"以禁用特定字段的可搜索性。这不会影响当前的索引映射，但可以通过索引模板继续应用。

修改为嵌套数据类型无法解决核心问题。

#### 检查问题

要确认索引的字段总数以检查映射爆炸：

* 检查 Elasticsearch 集群日志中是否有错误"已超出索引 [Y] 中的总字段 X] 限制"，其中"X"是"index.mapping.total_fields.limit"的值，"Y"是您的索引。相关的引入源日志错误将是"添加新字段 [Z] 时超出总字段 [X] 的限制"，其中"Z"是尝试新字段。  * 对于顶级字段，轮询 ['字段=*' 的字段功能。  * 在获取映射的输出中搜索"类型"。  * 如果您倾向于使用第三方工具 JQ，则可以处理 get mapping 'mapping.json' 输出。           $ 猫映射.json |JQ -C 'to_entries[]| .key 饰 $index|[.value.mappings| to_entries[]|选择(.key=="属性") |{(.key):([.value|..|.类型？|选择(.！=空)]|长度)}]|地图(to_entries)|展平|from_entries|([to_entries[].值]|添加)|{索引： $index， field_count： .}'

您可以使用分析索引磁盘使用情况来查找从未或很少填充为 easywin 的字段。

#### 复杂爆炸

映射爆炸还包括单个索引字段总数在限制范围内但组合索引字段总数非常高的情况。首先在数据视图上注意到症状，并通过解析索引 API 追溯到单个索引或索引子集，这是非常常见的。

但是，尽管不太常见，但可能只在后备索引组合上遇到映射爆炸。例如，如果数据流的支持索引都处于字段总数限制，但每个索引都包含彼此的唯一字段。

通过添加数据视图并检查其"字段**"选项卡以了解其字段总数，最容易出现这种情况。此统计数据确实会告诉您整个字段，而不仅仅是"index：true"的位置，而是作为良好的基线。

如果您的问题仅通过数据视图显示，则可以考虑使用此菜单的"字段筛选器"(如果您未使用多字段)。或者，您可以考虑更有针对性的索引模式或使用负模式来过滤掉有问题的索引。例如，如果"logs-*"由于有问题的后备索引"logs-lotsOfFields-*"而具有过高的字段计数，则可以更新为"logs-*，-logs-lotsOfFields-*"或"logs-iMeantThisAnyway-*"。

####Resolve

映射爆炸不容易解决，因此最好通过上述方法防止。遇到它通常表示意外的上游数据更改或计划失败。如果遇到这种情况，我们建议您查看数据体系结构。以下选项是本页前面讨论的选项的附加选项;它们应作为适用的最佳用例应用：

* 禁用动态映射。  * 通过索引模板或显式设置，使用更正的映射重新索引到索引中。  * 如果索引不需要和/或历史索引，请考虑删除。  * 通过 Logstash 修剪有问题的字段后，将数据导出并重新导入到映射更正的索引中。

拆分索引无法解决核心问题。

[« Task queue backlog](task-queue-backlog.md) [Hot spotting
»](hotspotting.md)
