

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[Set up a
cluster for high availability](high-availability.md) ›[Designing for
resilience](high-availability-cluster-design.md)

[« Resilience in small clusters](high-availability-cluster-small-
clusters.md) [Cross-cluster replication »](xpack-ccr.md)

## 大型集群中的弹性

节点共享公共基础设施(例如网络互连或电源)并不罕见。如果是这样，则应计划此基础结构的故障，并确保此类故障不会影响太多节点。通常的做法是将所有共享某些基础结构的节点分组到 _zones_ 中，并立即计划任何整个区域的故障。

Elasticsearch 希望节点到节点的连接可靠、延迟低且带宽充足。许多 Elasticsearch 任务需要在节点之间多次往返。缓慢或不可靠的互连可能会对集群的性能和稳定性产生重大影响。

例如，每次往返增加几毫秒的延迟可能会迅速累积成明显的性能损失。不可靠的网络可能具有频繁的网络分区。Elasticsearch 将尽快自动从网络分区中恢复，但您的集群在分区期间可能部分不可用，并且需要花费时间和资源来重新同步任何丢失的数据，并在分区修复后重新平衡自身。从故障中恢复可能涉及在节点之间复制大量数据，因此恢复时间通常由可用带宽决定。

如果已将群集划分为多个区域，则每个区域中的网络连接通常比区域之间的连接质量更高。确保区域之间的网络连接具有足够高的质量。将所有区域定位在单个数据中心内，每个区域都有自己独立的电源和其他支持基础结构，你将看到最佳结果。您还可以跨附近的数据中心_拉伸_您的集群，只要每对数据中心之间的网络互连足够好。

运行健康的 Elasticsearch 集群没有特定的最低网络性能要求。理论上，即使节点之间的往返延迟为几百毫秒，集群也能正常工作。实际上，如果您的网络速度很慢，那么集群性能将非常差。此外，慢速网络通常不够可靠，导致网络分区导致一段时间不可用。

如果希望数据在相距较远或连接不畅的多个数据中心中可用，请在每个数据中心部署单独的群集，并使用跨群集搜索或跨群集复制将群集链接在一起。即使群集到群集的连接不如每个群集中的网络可靠或性能低，这些功能也设计为性能良好。

在丢失整个区域的节点后，正确设计的集群可能正常运行，但运行的容量会显著降低。处理此类故障时，可能需要预配额外的节点以还原群集中可接受的性能。

为了抵御整个区域故障，必须在多个区域中存在每个分片的副本，这可以通过在多个区域中放置数据节点并配置分片分配感知来实现。还应确保将客户端请求发送到多个区域中的节点。

应考虑所有节点角色，并确保每个角色在两个或多个区域中冗余拆分。例如，如果使用引入管道或机器学习，则应在两个或多个区域中具有引入或机器学习节点。但是，放置符合主节点条件的节点需要更加小心，因为弹性集群至少需要三个符合主节点条件的节点中的两个才能正常运行。以下部分探讨了跨多个区域放置符合主条件的节点的选项。

### 双区集群

如果有两个区域，则每个区域中应具有不同数量的主节点，以便具有更多节点的区域将包含其中的大多数节点，并且能够在另一个区域丢失后幸存下来。例如，如果您有三个符合主节点条件的节点，则可以将它们全部放在一个区域中，或者您可以将两个节点放在一个区域中，将第三个节点放在另一个区域中。不应在每个区域中放置相同数量的符合主节点条件的节点。如果在每个区域中放置相同数量的符合主节点条件的节点，则两个区域都没有自己的多数节点。因此，群集可能无法在任一区域丢失后幸存下来。

### 具有 atiebreaker 的双区域集群

上述双区域部署容忍失去其中一个区域，但不能容忍失去另一个区域，因为主选举是基于多数的。您不能配置双区域群集，使其能够容忍 _both_ 区域的丢失，因为这在理论上是不可能的。您可能会期望，如果任一区域发生故障，那么 Elasticsearch 可以从剩余区域中选择一个节点作为主节点，但无法区分远程区域的故障和区域之间的连接丢失。如果两个区域都能够运行独立选举，那么失去连接将导致脑裂问题)，从而导致数据丢失。Elasticsearch 避免了这种情况，并通过从任一区域中选择一个节点作为主节点来保护您的数据，直到该节点可以确定它具有最新的集群状态并且集群中没有其他主节点。这可能意味着在连接恢复之前根本没有主节点。

您可以通过在两个区域中的每个区域中放置一个符合主节点条件的节点，并在独立的第三个区域中添加一个额外的符合主节点条件的节点来解决此问题。额外的主节点在两个原始区域彼此断开连接的情况下充当仲裁。额外的仲裁节点应该是专用的仅投票主节点，也称为专用仲裁节点。专用仲裁节点不需要像其他两个节点那样强大，因为它没有其他角色，不会执行任何搜索，也不会协调任何客户端请求，也不会被选为集群的主节点。

您应该使用分片分配感知来确保每个区域中都有每个分片的副本。这意味着，如果另一个区域发生故障，另一个区域将保持完全可用。

所有符合主节点条件的节点(包括仅投票节点)都位于发布群集状态更新的关键路径上。群集状态更新通常独立于性能关键型工作负荷(如索引或搜索)，但它们涉及管理活动，例如索引创建和滚动更新、映射更新和故障后恢复。这些活动的性能特征是每个符合主节点条件的存储速度以及群集中所有节点之间网络连接的可靠性和延迟的函数。因此，必须确保群集中节点可用的存储和网络足以满足性能目标。

### 具有三个或更多区域的集群

如果有三个区域，则每个区域中应有一个符合主节点条件的节点。如果您有三个以上的区域，则应选择其中三个区域，并在这三个区域中的每一个中放置一个符合主节点条件的节点。这意味着即使其中一个区域发生故障，集群仍然可以选择主节点。

与往常一样，您的索引应至少有一个副本，以防节点发生故障，除非它们是可搜索的快照索引。您还应该使用分片分配感知来限制每个区域中每个分片的副本数。例如，如果您有一个配置了一个或两个副本的索引，则分配感知将确保分片的副本与主副本位于不同的区域中。这意味着，如果一个区域发生故障，每个分片的副本仍然可用。此分片的可用性不会受到此类故障的影响。

###Summary

只要满足以下条件，群集就可以灵活应对任何区域的丢失：

* 群集运行状况为"绿色"。  * 至少有两个包含数据节点的区域。  * 除了主索引之外，每个不是可搜索快照索引的索引每个分片至少有一个副本。  * 分片分配感知配置为避免将分片的所有副本集中在单个区域中。  * 群集至少具有三个符合主节点条件的节点。这些节点中至少有两个不是仅投票的主节点，并且它们均匀分布在至少三个区域中。  * 客户端配置为将其请求发送到多个区域中的节点，或者配置为使用负载均衡器在一组适当的节点之间平衡请求。弹性云服务提供了这样的负载均衡器。

[« Resilience in small clusters](high-availability-cluster-small-
clusters.md) [Cross-cluster replication »](xpack-ccr.md)
