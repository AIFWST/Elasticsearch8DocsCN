

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[How
to](how-to.md)

[« Incorporating static relevance signals into the score](static-scoring-
signals.md) [Tune for search speed »](tune-for-search-speed.md)

## 调整索引速度

### 使用批量请求

批量请求将产生比单文档索引请求更好的性能。为了了解批量请求的最佳大小，您应该在具有单个分片的单个节点上运行基准测试。首先尝试一次索引 100 个文档，然后是 200 个，然后是 400 个，依此类推。在每次基准测试运行中，批量请求中的文档数量增加一倍。当索引速度开始稳定时，您就知道您达到了批量请求的最佳大小。在平局的情况下，最好是朝着太少而不是太多文件的方向犯错。请注意，当许多请求同时发送时，太大的批量请求可能会使集群面临内存压力，因此建议避免每个请求超过几十兆字节，即使较大的请求似乎性能更好。

### 使用多个工作线程/线程将数据发送到 Elasticsearch

发送批量请求的单个线程不太可能最大化 Elasticsearch 集群的索引容量。为了使用集群的所有资源，您应该从多个线程或进程发送数据。除了更好地利用集群的资源外，这还有助于降低每次 fsync 的成本。

确保注意"TOO_MANY_REQUESTS(429)"响应代码(Java客户端的"EsRejectedExecutionException")，这是Elasticsearch告诉您它无法跟上当前索引速率的方式。发生这种情况时，您应该在重试之前暂停索引，理想情况下使用随机指数退避。

与调整批量请求的大小类似，只有测试才能判断最佳工作器数。这可以通过逐步增加工作器数量来测试，直到集群上的 I/O 或 CPU 饱和。

### 取消设置或增加刷新间隔

使更改对搜索可见的操作(称为 arefresh \- )成本很高，并且在正在进行的索引活动时经常调用它可能会损害索引速度。

默认情况下，Elasticsearch 每秒定期刷新索引，但仅限于在过去 30 秒内收到一个或更多搜索请求的索引。

如果您没有搜索流量或搜索流量很少(例如，每 5 分钟少于一个搜索请求)并希望优化索引速度，这是最佳配置。此行为旨在默认情况下自动优化批量索引，当不执行搜索时。要选择退出此行为，请显式设置刷新间隔。

另一方面，如果您的索引遇到常规搜索请求，则此默认行为意味着 Elasticsearch 将每 1 秒刷新一次索引。如果您有能力增加文档被索引和它变得可见之间的时间量，那么将"index.refresh_interval"增加到更大的值，例如"30s"，可能有助于提高索引速度。

### 禁用初始加载的副本

如果你有大量的数据想要一次加载到Elasticsearch中，那么将"index.number_of_replicas"设置为"0"可能会有所帮助，以加快索引速度。没有副本意味着丢失单个节点可能会导致数据丢失，因此数据位于其他位置非常重要，以便在出现问题时可以重试此初始加载。初始加载完成后，您可以将"index.number_of_replicas"设置回其原始值。

如果在索引设置中配置了"index.refresh_interval"，则在此初始加载期间取消设置它并在初始加载完成后将其设置回原始值可能会进一步有所帮助。

### 禁用交换

您应该确保操作系统不会通过禁用交换来交换 javaprocess。

### 为文件系统缓存提供内存

文件系统缓存将用于缓冲 I/O 操作。你应该确保将运行Elasticsearch的计算机的至少一半内存提供给文件系统缓存。

### 使用自动生成的 ID

在索引具有显式 id 的文档时，Elasticsearch 需要检查同一分片中是否已经存在具有相同 id 的文档，这是一项成本高昂的操作，并且随着索引的增长而变得更加昂贵。通过使用自动生成的 ID，Elasticsearch 可以跳过此检查，从而使索引速度更快。

### 使用更快的硬件

如果索引是 I/O 绑定的，请考虑增加文件系统缓存的大小(见上文)或使用更快的存储。Elasticsearch通常使用顺序写入创建单个文件。但是，索引涉及同时写入多个文件，并且混合了随机和顺序读取，soSSD 驱动器往往比旋转磁盘性能更好。

通过配置 RAID 0 阵列，跨多个 SSD 条带化索引。请记住，这将增加故障的风险，因为任何一个 SSD 的故障都会破坏索引。但是，这通常是正确的权衡：优化单个分片以获得最佳性能，然后跨不同节点添加副本，以便为任何节点故障提供冗余。您还可以使用快照和还原来备份索引，以便进一步保险。

直连(本地)存储通常比远程存储性能更好，因为它更易于配置，并且避免了通信开销。通过仔细调整，有时也可以使用远程存储实现可接受的性能。使用实际工作负载对系统进行基准测试，以确定任何调优参数的影响。如果无法达到预期的性能，请与存储系统的供应商联系以确定问题所在。

### 索引缓冲区大小

如果您的节点只执行繁重索引，请确保"indices.memory.index_buffer_size"足够大，每个分片最多提供 512 MB 索引缓冲区(除此之外，索引性能通常不会提高)。Elasticsearch采用该设置(Java堆或绝对字节大小的百分比)，并将其用作所有活动分片的共享缓冲区。非常活跃的分片自然会比执行轻量级索引的分片更多地使用此缓冲区。

默认值为"10%"，这通常已经足够了：例如，如果您为 JVM10GB 提供内存，它将为索引缓冲区提供 1GB，这足以托管两个正在大量索引的分片。

### 使用跨集群复制防止搜索从索引中窃取资源

在单个群集中，索引和搜索可以争用资源。通过设置两个集群，配置跨集群复制以将数据从一个集群复制到另一个集群，并将所有搜索路由到具有追随者索引的集群，搜索活动将不再从托管领导者索引的集群上的索引中窃取资源。

### 避免热点

当节点资源、分片或请求分布不均匀时，可能会出现热点。Elasticsearch 通过跨节点同步来维护集群状态，因此持续出现热点节点可能会导致整体集群性能下降。

### 其他优化

磁盘usage__Tune中概述的许多策略也提高了索引速度。

[« Incorporating static relevance signals into the score](static-scoring-
signals.md) [Tune for search speed »](tune-for-search-speed.md)
