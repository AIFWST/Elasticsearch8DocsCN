

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[Roll up or
transform your data](data-rollup-transform.md) ›[Transforming
data](transforms.md)

[« Working with transforms at scale](transform-scale.md) [API quick
reference »](transform-api-quickref.md)

## 转换检查点的工作原理

每次转换检查源索引并创建或更新目标索引时，都会生成一个 _checkpoint_。

如果转换只运行一次，则逻辑上只有一个检查点。但是，如果转换持续运行，则会在引入和转换新的源数据时创建检查点。转换的"sync"属性通过指定时间字段来配置检查点。

要创建检查点，连续转换：

1. 检查源索引的更改。

转换使用简单的定期计时器检查对源索引的更改。此检查是根据转换的"频率"属性中定义的间隔完成的。

如果源索引保持不变，或者检查点已经在进行中，则它会等待下一个计时器。

如果找到更改，则会创建一个检查点。

2. 标识哪些实体和/或时间存储桶已更改。

转换将搜索以查看在最后一个检查点和新检查点之间更改了哪些实体或时间段。转换使用这些值来同步源索引和目标索引，其操作次数少于完全重新运行。

3. 使用更改更新目标索引(数据框)。

转换将与新的或更改的实体或时间存储桶相关的更改应用于目标索引。可以对更改集进行分页。转换执行的复合聚合类似于批处理转换操作，但它也会基于上一步注入查询筛选器以减少工作量。应用所有更改后，检查点即告完成。

此检查点过程涉及群集上的搜索和索引活动。我们试图在开发转换时倾向于控制性能。我们决定最好让转换需要更长的时间才能完成，而不是快速完成并优先于资源消耗。话虽如此，群集仍然需要足够的资源来支持复合聚合搜索及其结果的索引。

如果群集由于转换而遇到不合适的性能下降，请停止转换并参考性能注意事项。

#### 使用引入时间戳同步转换

在大多数情况下，强烈建议使用源索引的引入时间戳来同步转换。这是转换能够识别新更改的最佳方法。如果您的数据源遵循 ECS 标准，您可能已经有一个"event.ingested"字段。在这种情况下，请使用"event.ingested"作为转换的"sync.time".'field'属性。

如果没有"event.ingested"字段或未填充该字段，则可以使用引入管道进行设置。使用采集管道 API(如下例)或通过 Kibana 在"堆栈管理>摄取管道**"下创建采集管道。使用"set"处理器设置字段，并将其与摄取时间戳的值相关联。

    
    
    response = client.ingest.put_pipeline(
      id: 'set_ingest_time',
      body: {
        description: 'Set ingest timestamp.',
        processors: [
          {
            set: {
              field: 'event.ingested',
              value: '{{{_ingest.timestamp}}}'
            }
          }
        ]
      }
    )
    puts response
    
    
    PUT _ingest/pipeline/set_ingest_time
    {
      "description": "Set ingest timestamp.",
      "processors": [
        {
          "set": {
            "field": "event.ingested",
            "value": "{{{_ingest.timestamp}}}"
          }
        }
      ]
    }

创建采集管道后，将其应用于转换的源索引。管道将字段"event.ingested"添加到每个具有引入时间戳值的文档。配置转换的"sync'.'time'.'field'属性，以便通过将创建转换 API 用于新转换或更新转换 API 用于现有转换来使用该字段。"event.ingested"字段用于同步转换。

请参阅将管道添加到索引请求和引入管道，详细了解如何使用 aningest 管道。

#### 更改检测启发式

当转换在连续模式下运行时，它会在新数据传入时更新目标索引中的文档。转换使用一组称为更改检测的启发式方法，以更少的操作更新目标索引。

在此示例中，数据按主机名分组。更改检测检测哪些主机名已更改，例如主机"A"、"C"和"G"，并且仅使用这些主机更新文档，但不更新存储有关主机"B"、"D"或任何其他未更改主机的信息的文档。

当使用"date_histogram"按时间存储桶分组时，可以对时间存储桶应用另一种启发式方法。更改检测检测存储桶更改了哪些时间，并且仅更新这些时间。

#### 错误处理

转换中的失败往往与搜索或索引有关。为了提高转换的复原能力，聚合搜索和更改的实体搜索的游标位置将在内存中跟踪并定期持久化。

检查点失败可按如下方式分类：

* 临时失败：重试检查点。如果连续发生 10 次失败，则转换状态为失败。例如，当存在分片故障且查询仅返回部分结果时，可能会发生这种情况。  * 不可恢复的故障：转换立即失败。例如，当找不到源索引时，会出现这种情况。  * 调整失败：转换使用调整后的设置重试。例如，如果在复合聚合期间发生父断路器内存错误，则转换将收到部分结果。使用较少数量的存储桶重试聚合搜索。此重试按转换的"频率"属性中定义的间隔执行。如果重试搜索到达到最小存储桶数的程度，则会发生不可恢复的故障。

如果运行转换的节点失败，转换将从最近的持久游标位置重新启动。此恢复过程可能会重复转换已完成的某些工作，但它可确保数据一致性。

[« Working with transforms at scale](transform-scale.md) [API quick
reference »](transform-api-quickref.md)
