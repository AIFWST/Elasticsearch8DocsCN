

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md) ›[Secure the
Elastic Stack](secure-cluster.md) ›[User authorization](authorization.md)

[« Mapping users and groups to roles](mapping-roles.md) [Submitting requests
on behalf of other users »](run-as-privilege.md)

## 设置字段和文档级别安全性

您可以通过向角色添加字段和文档级安全权限来控制对数据流或索引中数据的访问。字段级安全性权限限制对文档中特定字段的访问。文档级安全权限限制对特定文档的访问。

文档和字段级安全性当前旨在使用只读特权帐户进行操作。为数据流或索引启用了文档和字段级别安全性的用户不应执行写入操作。

角色可以基于每个索引定义字段和文档级别权限。未指定字段级别权限的角色授予对 ALL 字段的访问权限。同样，未指定文档级权限的角色授予对索引中所有文档的访问权限。

为用户分配多个角色时，请注意不要无意中授予比预期更广泛的访问权限。每个用户对数据流或索引都有一组字段级别和文档级别权限。请参阅具有文档和字段级别安全性的多个角色。

### 具有文档和字段级别安全性的多个角色

一个用户可以有多个角色，每个角色可以对同一数据流或索引定义不同的权限。在此方案中，了解文档和字段级安全性的行为非常重要。

文档级安全性考虑用户持有的每个角色，并将给定数据流或索引的每个文档级安全性查询与"OR"组合在一起。这意味着只有一个角色查询必须匹配才能返回文档。例如，如果一个角色授予对没有文档级安全性的索引的访问权限，而另一个角色授予具有文档级安全性的访问权限，则不会应用文档级安全性;具有这两个角色的用户有权访问索引中的所有文档。

字段级安全性考虑用户拥有的每个角色，并将列出的所有字段合并到每个数据流或索引的单个集合中。例如，如果一个角色授予对没有字段级安全性的索引的访问权限，而另一个角色授予具有字段级安全性的访问权限，则不会对该索引应用字段级安全性;具有这两个角色的用户有权访问索引中的所有字段。

例如，假设"role_a"仅授予对"index1"中文档的"地址"字段的访问权限;它不指定任何文档限制。相反，"role_b"限制对"index1"中文档子集的访问;它不指定任何字段限制。如果为用户分配了两个角色，则"role_a"授予用户对所有文档的访问权限，"role_b"授予用户对所有字段的访问权限。

如果需要限制对文档和字段的访问，请考虑改为按索引拆分文档。

### 模板化角色查询

创建角色时，可以指定定义文档级安全权限的查询。您可以选择在角色查询中使用 Mustache 模板将当前经过身份验证的用户的用户名插入角色。与 Elasticsearch 中支持模板或脚本的其他位置一样，您可以指定内联、存储或基于文件的模板并定义自定义参数。您可以通过"_user"参数访问当前经过身份验证的用户的详细信息。

例如，以下角色查询使用模板插入当前经过身份验证的用户的用户名：

    
    
    POST /_security/role/example1
    {
      "indices" : [
        {
          "names" : [ "my-index-000001" ],
          "privileges" : [ "read" ],
          "query" : {
            "template" : {
              "source" : {
                "term" : { "acl.username" : "{{_user.username}}" }
              }
            }
          }
        }
      ]
    }

您可以通过"_user"变量访问以下信息：

物业 |描述 ---|--- '_user.用户名'

|

当前经过身份验证的用户的用户名。   '_user.全名'

|

如果指定，则为当前经过身份验证的用户的全名。   "_user.email"

|

如果指定，则为当前经过身份验证的用户的电子邮件。   "_user.角色"

|

如果已关联，则为当前经过身份验证的用户的角色名称列表。   "_user.元数据"

|

如果指定，则为保存当前经过身份验证的用户的自定义元数据的哈希。   您还可以访问自定义用户元数据。例如，如果您在用户元数据中维护"group_id"，则可以根据文档中的"group.id"字段应用文档级安全性：

    
    
    POST /_security/role/example2
    {
      "indices" : [
        {
          "names" : [ "my-index-000001" ],
          "privileges" : [ "read" ],
          "query" : {
            "template" : {
              "source" : {
                "term" : { "group.id" : "{{_user.metadata.group_id}}" }
              }
            }
          }
        }
      ]
    }

如果您的元数据字段包含对象或数组，您可以使用 '{{#toJson}}parameter{{/toJson}}' 函数访问它。

    
    
    POST /_security/role/example3
    {
      "indices" : [
        {
          "names" : [ "my-index-000001" ],
          "privileges" : [ "read" ],
          "query" : {
            "template" : {
              "source" : "{ \"terms\": { \"group.statuses\": {{#toJson}}_user.metadata.statuses{{/toJson}} }}"
            }
          }
        }
      ]
    }

### 预处理文档以添加安全详细信息

为了保证用户只阅读自己的文档，设置文档级别安全性是有意义的。在此方案中，每个文档都必须具有与之关联的用户名或角色名称，以便角色查询可以使用此信息来实现文档级安全性。在这种情况下，设置安全用户处理器摄取处理器可以提供帮助。

文档级安全性不适用于编写 API。您必须为使用相同数据流或索引的每个用户使用唯一的 ID，否则他们可能会覆盖其他用户的文档。采集处理器只是将当前经过身份验证的用户的属性添加到正在编制索引的文档。

设置安全用户处理器通过预处理摄取，将当前经过身份验证的用户相关详细信息(例如"用户名"、"角色"、"电子邮件"、"full_name"和"元数据")附加到当前文档。使用采集管道为数据编制索引时，用户详细信息会自动附加到文档。如果身份验证凭据是 API 密钥，则 API 密钥"id"、"名称"和"元数据"(如果存在且不为空)也会附加到文档中。

有关详细信息，请参阅引入管道和设置安全用户

[« Mapping users and groups to roles](mapping-roles.md) [Submitting requests
on behalf of other users »](run-as-privilege.md)
