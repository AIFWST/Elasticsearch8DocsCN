

[Elastic Docs](/guide/) ›[Elasticsearch Guide [8.9]](index.md)
›[Mapping](mapping.md)

[« Explicit mapping](explicit-mapping.md) [Map a runtime field »](runtime-
mapping-fields.md)

## 运行时字段

_runtime field_是在查询时计算的字段。运行时字段使您能够：

* 将字段添加到现有文档，而无需重新索引数据 * 在不了解数据结构的情况下开始使用数据 * 在查询时覆盖从索引字段返回的值 * 定义特定用途的字段，而无需修改底层架构

您可以像访问任何其他字段一样从搜索 API 访问运行时字段，而 Elasticsearch 对运行时字段的看法没有什么不同。您可以在索引映射或搜索请求中定义运行时字段。您的选择，这是运行时字段固有灵活性的一部分。

使用"_search"API 上的"字段"参数检索运行时字段的值。运行时字段不会显示在"_source"中，但"字段"API 适用于所有字段，即使是那些不是作为原始"_source"的一部分发送的字段。

运行时字段在处理日志数据时非常有用(请参阅示例)，尤其是在不确定数据结构时。您的搜索速度会降低，但索引大小要小得多，您可以更快地处理日志，而无需为它们编制索引。

###Benefits

由于运行时字段未编制索引，因此添加运行时字段不会增加索引大小。您可以直接在索引映射中定义运行时字段，从而节省存储成本并提高引入速度。您可以更快地将数据摄取到 Elastic Stack 中并立即访问。定义运行时字段时，可以立即在搜索请求、聚合、筛选和排序中使用它。

如果将运行时字段更改为索引字段，则无需修改引用运行时字段的任何查询。更好的是，您可以引用字段是运行时字段的某些索引，以及字段是索引字段的其他索引。您可以灵活地选择要编制索引的字段以及将哪些字段保留为运行时字段。

从本质上讲，运行时字段最重要的好处是能够在引入文档后向文档添加字段。此功能简化了映射决策，因为您不必预先决定如何分析数据，并且可以随时使用运行时字段修改映射。使用运行时字段允许更小的索引和更快的摄取时间，从而使用更少的资源并降低运营成本。

###Incentives

运行时字段可以取代许多将脚本与"_search"API 一起使用的方式。使用运行时字段的方式受所包含脚本所针对的文档数的影响。例如，如果您在"_search"API 上使用"fields"参数来检索运行时字段的值，则该脚本仅针对热门运行，就像脚本字段一样。

您可以使用脚本字段访问"_source"中的值，并根据脚本评估返回计算值。运行时字段具有相同的功能，但提供了更大的灵活性，因为您可以在搜索请求中查询和聚合运行时字段。脚本字段只能提取值。

同样，您可以编写一个脚本查询，用于基于脚本筛选搜索请求中的文档。运行时字段提供了非常相似的功能，但更灵活。您编写一个脚本来创建字段值，它们在任何地方都可用，例如"字段"、"所有查询"和聚合。

您还可以使用脚本对搜索结果进行排序，但该脚本在运行时字段中的工作方式完全相同。

如果将脚本从搜索请求中的任何这些部分移动到从相同数量的文档中计算值的运行时字段，则性能应大致相同。这些功能的性能在很大程度上取决于所包含的脚本正在运行的计算以及脚本针对的文档数运行。

###Compromises

运行时字段使用较少的磁盘空间，并提供了访问数据的灵活性，但可能会根据运行时脚本中定义的计算影响搜索性能。

为了平衡搜索性能和灵活性，请为您经常搜索和筛选的字段(如时间戳)编制索引。Elasticsearch 在运行查询时自动首先使用这些索引字段，从而缩短响应时间。然后，您可以使用运行时字段来限制 Elasticsearch 需要计算值的字段数。将索引字段与运行时字段结合使用可以灵活地编制索引的数据以及如何定义其他字段的查询。

使用异步搜索 API 运行包含运行时字段的搜索。这种搜索方法有助于抵消包含该字段的每个文档中运行时字段的计算值对性能的影响。如果查询无法同步返回结果集，你将在结果可用时异步获取结果。

针对运行时字段的查询被认为是昂贵的。如果"search.allow_expensive_queries"设置为"false"，则不允许进行昂贵的查询，并且 Elasticsearch 将拒绝任何针对运行时字段的查询。

[« Explicit mapping](explicit-mapping.md) [Map a runtime field »](runtime-
mapping-fields.md)
